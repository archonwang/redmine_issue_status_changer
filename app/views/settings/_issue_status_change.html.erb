<h3><%= l(:issue_status_change) %></h3>
<%= l(:issue_status_change_help) %>
<pre><%= l(:issue_status_change_rake_task) %></pre>


<% settings['status_change'] = Hash.new if settings['status_change'] == nil %>
<% settings['new_status'] = Hash.new if settings['new_status'] == nil %>
<% settings['status_message'] = l(:status_message) if settings['status_message'] == nil %>

<fieldset>
  <legend><%= l(:status_message_legend) %></legend>
  <p>
    <label><%= l(:status_message_label) %></label>
    <%= text_field_tag "settings[status_message]", settings[:status_message] %>
  </p>
</fieldset>

<% Tracker.all.each do |tracker| %>


<fieldset>
    <legend><%= tracker.name %></legend>
    <p>
        <label><%= l(:change_status_label) %></label>
        <%= check_box_tag "settings[status_change][#{tracker.id}]", "1", @settings[:status_change][tracker.id.to_s] %>
        <br/><br/>
        <label id="settings_new_status_<%= tracker.id %>_label"><%= l(:new_status) %></label>
        <%= select_tag "settings[new_status][#{tracker.id}", options_for_select(IssueStatus.joins(:workflow_transitions_as_new_status).where(:workflows => {:tracker_id => tracker.id}, :is_closed => 1).uniq.map {|s| [s.name, s.id]},@settings[:new_status][tracker.id.to_s]) %>
    </p>
</fieldset>
<% end %>

<%= javascript_tag do %>
$(document).ready(function() {
  $('[id^=settings_status_change_]').click(function() {
    tracker_id = this.id.substring(this.id.lastIndexOf("_")+1);
    if ($('#settings_status_change_'+tracker_id).is(':checked')) {
      $('#settings_new_status_'+tracker_id).show();
      $('#settings_new_status_'+tracker_id+'_label').show();
    }
    else {
      $('#settings_new_status_'+tracker_id).hide();
      $('#settings_new_status_'+tracker_id+'_label').hide();
    }
  });
});

$('[id^=settings_status_change_]:not(:checked)').each(function(index) {
    tracker_id = this.id.substring(this.id.lastIndexOf("_")+1);
    $('#settings_new_status_'+tracker_id).hide();
    $('#settings_new_status_'+tracker_id+'_label').hide();
});
<% end %>